<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=no"
    />
    <title>i.c.Stars Cycle 58</title>
    <style>
      :root {
        --accent: #007bff;
        --good: #28a745;
        --bad: #dc3545;
        --card: #fff;
        --primary: #2c3e50;
        --secondary: #34495e;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #2c3e50;
        min-height: 100vh;
      }
      .wrap {
        max-width: 100%;
        margin: 0;
        padding: 0 10px;
      }
      header {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }
      h1 {
        font-size: 2rem;
        margin: 0 0 8px 0;
        color: var(--primary);
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      .contributors {
        font-size: 1rem;
        color: var(--secondary);
        margin: 8px 0 20px 0;
        font-weight: 500;
      }
      .header-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: 0;
        padding: 12px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        min-height: 44px;
        min-width: 80px;
        font-size: 0.9rem;
      }
      button:hover,
      button:active {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
      }
      @media (max-width: 768px) {
        .wrap {
          padding: 0 5px;
        }
        header {
          flex-direction: column;
          gap: 10px;
        }
        h1 {
          font-size: 1.1rem;
        }
        button {
          padding: 10px 14px;
          font-size: 0.8rem;
        }
      }
      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      @media (max-width: 768px) {
        .controls-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
      }
      .branch-control {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
        text-align: center;
      }
      .branch-control:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0, 123, 255, 0.15);
      }
      .branch-title {
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 1.1rem;
        color: var(--primary);
      }
      .branch-pin {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 15px;
        font-weight: 500;
      }
      .branch-status {
        font-weight: 700;
        padding: 8px 16px;
        border-radius: 20px;
        margin-bottom: 15px;
        font-size: 0.9rem;
        display: inline-block;
      }
      .branch-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .branch-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
        border-radius: 8px;
        flex: 1;
        transition: all 0.2s ease;
        min-height: 40px;
        font-weight: 600;
        border: none;
        cursor: pointer;
      }
      .branch-btn.on {
        background: var(--good);
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      }
      .branch-btn.off {
        background: var(--bad);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
      }

      .card {
        background: #fff;
        color: var(--primary);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .status {
        font-weight: 700;
        padding: 6px 10px;
        border-radius: 15px;
        color: #fff;
        font-size: 0.8rem;
      }
      .row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 10px;
      }
      .small {
        font-size: 0.8rem;
        color: #666;
      }
      .footer {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 30px;
        text-align: center;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      @media (max-width: 768px) {
        .card {
          padding: 12px;
          margin-bottom: 12px;
        }
        .status {
          padding: 5px 8px;
          font-size: 0.75rem;
        }
        .small {
          font-size: 0.75rem;
        }
        .footer {
          font-size: 0.75rem;
          padding: 12px;
          margin-top: 15px;
        }
      }

      @media (max-width: 480px) {
        .card {
          padding: 10px;
        }
        .footer {
          font-size: 0.7rem;
          padding: 10px;
        }
      }
      .danger {
        background: var(--bad);
      }
      .ok {
        background: var(--good);
      }

      .ack-section {
        background: rgba(248, 249, 250, 0.95);
        border-left: 4px solid #17a2b8;
        font-family: monospace;
        font-size: 0.8rem;
      }

      .motion-meter {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .meter-container {
        flex: 1;
        margin: 0 15px;
        position: relative;
      }

      .meter-gauge {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: conic-gradient(
          from 135deg,
          #dc3545 0deg,
          #ffc107 45deg,
          #28a745 90deg,
          #28a745 135deg,
          #ffc107 180deg,
          #dc3545 225deg
        );
        position: relative;
        margin: 0 auto;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
      }

      .meter-inner {
        position: absolute;
        top: 15px;
        left: 15px;
        width: 90px;
        height: 90px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .meter-needle {
        position: absolute;
        width: 2px;
        height: 35px;
        background: #333;
        top: 20px;
        left: 59px;
        transform-origin: bottom center;
        transform: rotate(0deg);
        transition: transform 0.5s ease;
        border-radius: 1px;
        z-index: 10;
      }

      .meter-needle::after {
        content: "";
        position: absolute;
        bottom: -3px;
        left: -2px;
        width: 6px;
        height: 6px;
        background: #333;
        border-radius: 50%;
      }

      .meter-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary);
        margin: 0;
      }

      .meter-label {
        font-size: 0.7rem;
        color: #666;
        margin: 2px 0 0 0;
        text-transform: uppercase;
      }

      .meter-status {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #dc3545;
        transition: all 0.3s ease;
      }

      .status-indicator.active {
        background: #28a745;
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.6);
        animation: pulse-indicator 2s infinite;
      }

      @keyframes pulse-indicator {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
      }

      @media (max-width: 768px) {
        .motion-meter {
          flex-direction: column;
          gap: 15px;
        }
        .meter-gauge {
          width: 100px;
          height: 100px;
        }
        .meter-inner {
          width: 75px;
          height: 75px;
          top: 12.5px;
          left: 12.5px;
        }
        .meter-needle {
          height: 30px;
          top: 17px;
          left: 49px;
        }
        .meter-value {
          font-size: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>i.c.Stars Cycle 58</h1>
        <div class="contributors">By: Ma'ati & Maya</div>
        <div class="header-buttons">
          <button id="connectBtn">Connect</button>
        </div>
      </header>

      <div
        id="connectionState"
        class="small"
        style="margin: 10px 0; text-align: center; font-weight: 500"
        >Not connected</div
      >

      <div class="controls-grid">
        <div class="branch-control" id="branch-0">
          <div class="branch-title">Hardware</div>
          <div class="branch-pin">Pin GP15</div>
          <div id="badge0" class="branch-status danger">OFF</div>
          <div class="branch-buttons">
            <button id="on0" class="branch-btn on">ON</button>
            <button id="off0" class="branch-btn off">OFF</button>
          </div>
        </div>

        <div class="branch-control" id="branch-1">
          <div class="branch-title">microPy</div>
          <div class="branch-pin">Pin GP16</div>
          <div id="badge1" class="branch-status danger">OFF</div>
          <div class="branch-buttons">
            <button id="on1" class="branch-btn on">ON</button>
            <button id="off1" class="branch-btn off">OFF</button>
          </div>
        </div>

        <div class="branch-control" id="branch-2">
          <div class="branch-title">IDE's</div>
          <div class="branch-pin">Pin GP17</div>
          <div id="badge2" class="branch-status danger">OFF</div>
          <div class="branch-buttons">
            <button id="on2" class="branch-btn on">ON</button>
            <button id="off2" class="branch-btn off">OFF</button>
          </div>
        </div>

        <div class="branch-control" id="branch-3">
          <div class="branch-title">Software</div>
          <div class="branch-pin">Pin GP18</div>
          <div id="badge3" class="branch-status danger">OFF</div>
          <div class="branch-buttons">
            <button id="on3" class="branch-btn on">ON</button>
            <button id="off3" class="branch-btn off">OFF</button>
          </div>
        </div>

        <div class="branch-control" id="branch-4">
          <div class="branch-title">Github pages IO</div>
          <div class="branch-pin">Pin GP19</div>
          <div id="badge4" class="branch-status danger">OFF</div>
          <div class="branch-buttons">
            <button id="on4" class="branch-btn on">ON</button>
            <button id="off4" class="branch-btn off">OFF</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 10px">
        <div class="motion-meter">
          <div
            class="small"
            style="font-size: 1rem; font-weight: 600; color: var(--primary)"
            >Motion Sensor</div
          >
          <div class="meter-container">
            <div class="meter-gauge">
              <div class="meter-inner">
                <div class="meter-value" id="motionValue">0</div>
                <div class="meter-label">Motion</div>
              </div>
              <div class="meter-needle" id="motionNeedle"></div>
            </div>
          </div>
          <div class="meter-status">
            <div class="status-indicator" id="motionIndicator"></div>
            <div class="small" id="motionStatus">Inactive</div>
          </div>
        </div>
        <div style="height: 10px"></div>
        <div class="small">Raw notifications:</div>
        <pre
          id="raw"
          style="
            background: #f7f9fb;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #eee;
            max-height: 140px;
            overflow: auto;
          "
        ></pre>
      </div>

      <div class="card ack-section" style="margin-top: 10px">
        <div class="small" style="margin-bottom: 6px">ACK Messages:</div>
        <pre
          id="ackMessages"
          style="
            background: #fff;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            max-height: 100px;
            overflow: auto;
            min-height: 50px;
          "
        ></pre>
      </div>

      <div class="footer"
        >Use Chrome on Android for best Web Bluetooth support. Click Connect,
        pick <strong>PicoW2-BLE</strong>, then allow notifications.</div
      >
    </div>

    <script>
      // UUIDs (match your main_ble and Nordic UART-style service)
      const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // notify
      const RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e"; // write

      let device = null;
      let server = null;
      let rxChar = null;
      let txChar = null;
      let states = [0, 0, 0, 0, 0];
      let motion = 0;

      const connectBtn = document.getElementById("connectBtn");
      const connState = document.getElementById("connectionState");
      const rawEl = document.getElementById("raw");
      const ackEl = document.getElementById("ackMessages");
      const motionValue = document.getElementById("motionValue");
      const motionNeedle = document.getElementById("motionNeedle");
      const motionIndicator = document.getElementById("motionIndicator");
      const motionStatus = document.getElementById("motionStatus");

      connectBtn.addEventListener("click", async () => {
        if (device && device.gatt.connected) {
          await disconnect();
          return;
        }
        try {
          connState.textContent = "Requesting device...";
          device = await navigator.bluetooth.requestDevice({
            filters: [{ name: "PicoW2-BLE" }],
            optionalServices: [SERVICE_UUID],
          });
          connState.textContent = "Connecting...";
          server = await device.gatt.connect();
          connState.textContent = "Connected";
          connectBtn.textContent = "Disconnect";

          const service = await server.getPrimaryService(SERVICE_UUID);
          txChar = await service.getCharacteristic(TX_UUID);
          rxChar = await service.getCharacteristic(RX_UUID);

          await txChar.startNotifications();
          txChar.addEventListener("characteristicvaluechanged", onNotify);

          // request initial status
          await sendCmd("STATUS");
        } catch (err) {
          connState.textContent = "Connect failed: " + err;
        }
      });

      async function disconnect() {
        try {
          if (txChar)
            txChar.removeEventListener("characteristicvaluechanged", onNotify);
          if (device && device.gatt.connected) await device.gatt.disconnect();
        } catch (e) {
          console.log("disconnect problem", e);
        }
        device = null;
        server = null;
        rxChar = null;
        txChar = null;
        connectBtn.textContent = "Connect";
        connState.textContent = "Not connected";
      }

      function onNotify(event) {
        const value = new TextDecoder().decode(event.target.value);

        try {
          const j = JSON.parse(value);
          // This is JSON status data
          rawEl.textContent += value + "\n";
          if (j.states) {
            states = j.states;
            updateBranchBadges();
          }
          if (typeof j.motion !== "undefined") {
            motion = j.motion;
            updateMotionGauge(motion);
          }
        } catch (e) {
          // Not JSON - treat as ACK message
          ackEl.textContent += value + "\n";
          // Also keep a copy in raw for debugging
          rawEl.textContent += "[ACK] " + value + "\n";
        }
      }

      async function sendCmd(s) {
        if (!rxChar) {
          alert("Not connected to RX characteristic");
          return;
        }
        const encoder = new TextEncoder();
        await rxChar.writeValue(encoder.encode(s));
      }

      function updateBranchBadges() {
        for (let i = 0; i < 5; i++) {
          const badge = document.getElementById("badge" + i);
          if (!badge) continue;

          badge.textContent = states[i] ? "ON" : "OFF";
          badge.className = "branch-status " + (states[i] ? "ok" : "danger");
        }
      }

      function updateMotionGauge(motionState) {
        // Update the gauge value (0-100 scale)
        const displayValue = motionState ? 85 : 0;

        // Update needle position (rotate from -90deg to +90deg)
        const needleRotation = motionState ? 45 : -90;
        if (motionNeedle) {
          motionNeedle.style.transform = `rotate(${needleRotation}deg)`;
        }

        // Update status indicator and text
        if (motionIndicator) {
          if (motionState) {
            motionIndicator.classList.add("active");
          } else {
            motionIndicator.classList.remove("active");
          }
        }

        if (motionStatus) {
          motionStatus.textContent = motionState ? "Active" : "Inactive";
        }

        // Update the numeric display
        if (document.getElementById("motionValue")) {
          document.getElementById("motionValue").textContent = displayValue;
        }
      }

      // Attach event handlers to existing buttons
      for (let i = 0; i < 5; i++) {
        document
          .getElementById("on" + i)
          .addEventListener("click", () => sendCmd("ON" + i));
        document
          .getElementById("off" + i)
          .addEventListener("click", () => sendCmd("OFF" + i));
      }

      // shortcut: long-poll current status every 15s while connected
      setInterval(() => {
        if (txChar) sendCmd("STATUS");
      }, 15000);
    </script>
  </body>
</html>
